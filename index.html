<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISRAEL GADGETS ‚Äì Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for beautiful graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ----- GLOBAL STYLES (refined for a smarter look) ----- */
        :root{
            --brand-red: #e41e2b;
            --brand-blue: #1a5fb4;
            --brand-yellow: #f5a524;
            --brand-white: #ffffff;
            --brand-black: #000000;
            --success:#26a269;
            --danger:#c01c28;
            --warning:#f5a524;
            --dark:#241f31;
            --sale:#c64600;
            --electric:#9141ac;
            --shadow-sm: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-hover: 0 8px 20px rgba(0,0,0,0.12);
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            background: #f0f4f8;
            color: #111;
            line-height: 1.6;
        }
        /* ----- LOGIN PAGE (modern card) ----- */
        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(145deg, #f9fbfd 0%, #eef2f6 100%);
            padding: 20px;
        }
        .login-card {
            background: var(--brand-white);
            max-width: 460px;
            width: 100%;
            padding: 40px 35px;
            border-radius: 32px;
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.25);
            border: none;
            text-align: center;
        }
        .shop-logo-login {
            width: 115px;
            height: 115px;
            object-fit: cover;
            border-radius: 50%;
            border: 4px solid var(--brand-blue);
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
        }
        .login-card h2 {
            color: var(--brand-red);
            margin-bottom: 25px;
            font-size: 28px;
            font-weight: 600;
        }
        .input-field {
            width: 100%;
            padding: 15px 18px;
            margin: 10px 0;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-size: 16px;
            transition: all 0.2s;
            background: #fafcfc;
        }
        .input-field:focus {
            border-color: var(--brand-red);
            box-shadow: 0 0 0 4px rgba(228,30,43,0.15);
            outline: none;
            background: white;
        }
        .btn {
            padding: 16px 20px;
            border-radius: 40px;
            border: none;
            cursor: pointer;
            background: linear-gradient(145deg, var(--brand-red), #b0121e);
            color: white;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
            box-shadow: 0 8px 16px -6px rgba(228,30,43,0.4);
        }
        .btn:hover {
            background: linear-gradient(145deg, #b0121e, var(--brand-red));
            transform: translateY(-2px);
            box-shadow: 0 12px 20px -8px rgba(228,30,43,0.5);
        }
        .error-message {
            color: var(--brand-red);
            margin-top: 15px;
            font-size: 14px;
            min-height: 40px;
            white-space: pre-line;
            text-align: left;
            background: #fff0f0;
            padding: 12px;
            border-radius: 16px;
            border-left: 4px solid var(--brand-red);
        }
        /* ----- DASHBOARD LAYOUT (clean & professional) ----- */
        #dashboard-container {
            display: none;
        }
        .dashboard-wrapper {
            display: flex;
            min-height: 100vh;
            flex-direction: column;
        }
        /* Fixed header with hide/show on scroll ‚Äì reduced height */
        .admin-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(135deg, var(--brand-red), #b81422);
            padding: 8px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: white;
            border-bottom: 2px solid var(--brand-yellow);
            flex-wrap: wrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        .admin-header.half-hidden {
            transform: translateY(-50%);
        }
        /* Placeholder to maintain layout when header is fixed */
        .header-placeholder {
            height: 70px;
            width: 100%;
        }
        .admin-header .logo-area {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .admin-header img {
            height: 60px;
            width: 60px;
            border-radius: 50%;
            border: 1px solid var(--brand-yellow);
            object-fit: cover;
        }
        .admin-header h1 {
            font-size: 19px;
            font-weight: 600;
            letter-spacing: -0.5px;
            margin: 0;
        }
        .admin-header .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .btn-logout {
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(5px);
            color: white;
            border: 2px solid var(--brand-yellow);
            padding: 6px 15px;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            font-size: 14px;
        }
        .btn-logout:hover {
            background: white;
            color: var(--brand-black);
            border-color: white;
        }
        .main-layout {
            display: flex;
            flex: 1;
        }
        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid rgba(0,0,0,0.05);
            padding: 25px 0;
            box-shadow: 4px 0 12px rgba(0,0,0,0.03);
        }
        .sidebar ul {
            list-style: none;
        }
        .sidebar li {
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 500;
            color: #2d3e50;
            display: flex;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            transition: 0.2s;
            border-left: 4px solid transparent;
            margin: 4px 0;
        }
        .sidebar li:hover {
            background: linear-gradient(90deg, rgba(228,30,43,0.06), transparent);
            border-left-color: var(--brand-red);
            color: var(--brand-red);
        }
        .sidebar li.active {
            background: linear-gradient(90deg, rgba(228,30,43,0.12), transparent);
            border-left-color: var(--brand-red);
            color: var(--brand-red);
            font-weight: 600;
        }
        .sidebar i {
            width: 28px;
            font-size: 1.3rem;
            color: var(--brand-blue);
        }
        .content-area {
            flex: 1;
            padding: 30px;
            background: #f8fafc;
            overflow-x: auto;
        }
        .section-title {
            color: var(--brand-red);
            margin-bottom: 25px;
            padding-bottom: 12px;
            border-bottom: 3px solid var(--brand-blue);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.8rem;
            font-weight: 600;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 24px;
            border: none;
            box-shadow: var(--shadow-sm);
            transition: 0.25s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }
        .stat-card .label {
            color: #64748b;
            font-size: 15px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }
        .stat-card .value {
            font-size: 38px;
            font-weight: 700;
            color: var(--brand-red);
            line-height: 1.2;
        }
        .table-responsive {
            overflow-x: auto;
            border-radius: 20px;
            background: white;
            box-shadow: var(--shadow-sm);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 20px;
            overflow: hidden;
        }
        th {
            background: linear-gradient(145deg, var(--brand-red), #b81422);
            color: white;
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.95rem;
        }
        td {
            padding: 14px 12px;
            border-bottom: 1px solid #edf2f7;
        }
        tr:last-child td {
            border-bottom: none;
        }
        tr:hover td {
            background: #fafdff;
        }
        .badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 40px;
            font-size: 13px;
            font-weight: 600;
            text-transform: capitalize;
        }
        .badge.pending { background: #fff3cd; color: #856404; }
        .badge.confirmed { background: #d1ecf1; color: #0c5460; }
        .badge.delivered { background: #d4edda; color: #155724; }
        .badge.cancelled { background: #f8d7da; color: #721c24; }
        .form-container {
            background: white;
            padding: 35px;
            border-radius: 28px;
            border: none;
            max-width: 900px;
            box-shadow: var(--shadow-sm);
        }
        .form-group {
            margin-bottom: 22px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--brand-blue);
            font-size: 0.95rem;
        }
        .form-control {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            font-size: 15px;
            transition: 0.2s;
            background: white;
        }
        .form-control:focus {
            border-color: var(--brand-red);
            outline: none;
            box-shadow: 0 0 0 4px rgba(228,30,43,0.15);
        }
        .btn-sm {
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 40px;
            border: none;
            background: linear-gradient(145deg, var(--brand-red), #b0121e);
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 10px rgba(228,30,43,0.3);
        }
        .btn-sm:hover {
            background: linear-gradient(145deg, #b0121e, var(--brand-red));
            transform: translateY(-2px);
        }
        .btn-danger {
            background: #6b2b2b;
            box-shadow: none;
        }
        .btn-danger:hover {
            background: #4e1e1e;
        }
        .btn-success {
            background: var(--success);
            box-shadow: 0 4px 10px rgba(38,162,105,0.3);
        }
        .action-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .toast {
            position: fixed;
            top: 25px;
            right: 25px;
            background: linear-gradient(145deg, var(--brand-red), #b0121e);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            border: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 9999;
            animation: slideIn 0.25s ease-out;
            font-weight: 500;
        }
        @keyframes slideIn {
            from { transform: translateX(120%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .hidden { display: none; }
        .text-center { text-align: center; }
        .mt-4 { margin-top: 30px; }
        .developer-footer {
            margin-top: 50px;
            padding-top: 25px;
            border-top: 2px dashed var(--brand-blue);
            color: #64748b;
            font-size: 14px;
            text-align: center;
        }
        /* Sales range dropdown */
        .sales-range-selector {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .sales-range-selector select {
            padding: 8px 16px;
            border-radius: 40px;
            border: 2px solid var(--brand-blue);
            background: white;
            font-weight: 600;
            color: var(--brand-black);
            cursor: pointer;
        }
        /* Gradient preview */
        .gradient-preview {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        /* Chart container */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-bottom: 20px;
        }
        @media (max-width: 768px) {
            .main-layout { flex-direction: column; }
            .sidebar { width: 100%; border-right: none; border-bottom: 1px solid #ddd; }
            .admin-header { flex-direction: column; gap: 8px; }
        }
        /* Bundle item row */
        .bundle-item-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .bundle-item-row input[type="text"] { flex: 2; min-width: 180px; }
        .bundle-item-row input[type="number"] { width: 120px; }
        .bundle-item-row .btn-remove-item {
            background: #c01c28;
            color: white;
            border: none;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            font-weight: bold;
            cursor: pointer;
        }
        /* Dynamic row styles for settings */
        .dynamic-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            background: #f9f9fc;
            padding: 12px;
            border-radius: 16px;
            border: 1px solid #e9edf2;
        }
        .dynamic-row .field {
            flex: 1;
            min-width: 150px;
        }
        .btn-remove-row {
            background: #c01c28;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-add-row {
            background: var(--brand-blue);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- ========== LOGIN PAGE (with toggleable sign-up) ========== -->
    <div id="login-container">
        <div class="login-card" id="login-card">
            <img src="https://i.supaimg.com/c60dbe6d-a5fc-4af2-8f02-c357aab69161.jpg" alt="ISRAEL GADGETS Logo" class="shop-logo-login">

            <!-- LOGIN FORM (visible by default) -->
            <div id="login-form-block">
                <h2>Admin Login</h2>
                <form id="admin-login-form">
                    <input type="email" id="login-email" class="input-field" placeholder="Email address" required>
                    <input type="password" id="login-password" class="input-field" placeholder="Password" required>
                    <button type="submit" class="btn">Login</button>
                    <div id="login-error" class="error-message"></div>
                </form>
                <p style="margin-top: 18px;">
                    <a href="#" onclick="toggleAuthMode('signup')" style="color: var(--brand-blue);">Don't have an account? Sign up</a>
                </p>
            </div>

            <!-- SIGNUP FORM (hidden initially) -->
            <div id="signup-form-block" style="display: none;">
                <h2>Create Account</h2>
                <form id="admin-signup-form">
                    <input type="text" id="signup-name" class="input-field" placeholder="Full name" required>
                    <input type="email" id="signup-email" class="input-field" placeholder="Email address" required>
                    <input type="tel" id="signup-phone" class="input-field" placeholder="Phone number (optional)">
                    <input type="password" id="signup-password" class="input-field" placeholder="Password" required>
                    <input type="password" id="signup-confirm" class="input-field" placeholder="Confirm password" required>
                    <button type="submit" class="btn">Sign Up</button>
                    <div id="signup-error" class="error-message"></div>
                </form>
                <p style="margin-top: 18px;">
                    <a href="#" onclick="toggleAuthMode('login')" style="color: var(--brand-blue);">‚Üê Back to login</a>
                </p>
            </div>
        </div>
    </div>

    <!-- ========== DASHBOARD (full management) ========== -->
    <div id="dashboard-container">
        <div class="dashboard-wrapper">
            <!-- Admin Header (fixed) ‚Äì reduced height -->
            <header class="admin-header" id="adminHeader">
                <div class="logo-area">
                    <img src="https://i.supaimg.com/c60dbe6d-a5fc-4af2-8f02-c357aab69161.jpg" alt="Israel Gadgets">
                    <h1>ISRAEL GADGETS ‚Äì ADMIN</h1>
                </div>
                <div class="user-info">
                    <span id="admin-email-display"></span>
                    <button onclick="handleLogout()" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </header>
            <!-- Placeholder div to maintain spacing when header is fixed -->
            <div class="header-placeholder" id="headerPlaceholder"></div>

            <!-- Main Layout with Sidebar -->
            <div class="main-layout">
                <div class="sidebar">
                    <ul>
                        <li id="menu-dashboard" onclick="loadSection('dashboard')" class="active">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </li>
                        <li id="menu-categories" onclick="loadSection('categories')">
                            <i class="fas fa-tags"></i> Categories
                        </li>
                        <li id="menu-products" onclick="loadSection('products')">
                            <i class="fas fa-mobile-alt"></i> Products
                        </li>
                        <li id="menu-orders" onclick="loadSection('orders')">
                            <i class="fas fa-shopping-cart"></i> Orders
                        </li>
                        <li id="menu-order-items" onclick="loadSection('order_items')">
                            <i class="fas fa-list-ul"></i> Order Items
                        </li>
                        <li id="menu-promotions" onclick="loadSection('promotions')">
                            <i class="fas fa-tags"></i> Promotions
                        </li>
                        <li id="menu-bundles" onclick="loadSection('bundles')">
                            <i class="fas fa-gift"></i> Bundles
                        </li>
                        <li id="menu-reviews" onclick="loadSection('reviews')">
                            <i class="fas fa-star"></i> Reviews
                        </li>
                        <li id="menu-settings" onclick="loadSection('settings')">
                            <i class="fas fa-cog"></i> Settings
                        </li>
                        <!-- New: Contact and Location Settings -->
                        <li id="menu-contact-settings" onclick="loadSection('contactSettings')">
                            <i class="fas fa-address-book"></i> Contact Settings
                        </li>
                        <li id="menu-location-settings" onclick="loadSection('locationSettings')">
                            <i class="fas fa-map-marked-alt"></i> Location Settings
                        </li>
                        <li id="menu-users" onclick="loadSection('users')">
                            <i class="fas fa-users"></i> Users
                        </li>
                    </ul>
                </div>

                <!-- Dynamic Content Area -->
                <div class="content-area" id="content-area">
                    <div class="text-center" style="padding: 50px;">
                        <i class="fas fa-spinner fa-spin fa-3x" style="color: var(--brand-red);"></i>
                        <p style="margin-top: 20px;">Loading dashboard...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== SUPABASE INIT ==========
        const SUPABASE_URL = 'https://xljtstvujqhlkqpcbtvm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsanRzdHZ1anFobGtxcGNidHZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMDkwNDMsImV4cCI6MjA4NjU4NTA0M30.EIOVRbym8pOa7zNFp_wyqqfSF5_H0OZxit8nFRsJRBY';
        const supabaseAdmin = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ========== GLOBAL STATE ==========
        let currentUser = null;
        let currentAdminProfile = null;
        let categoriesCache = [];
        let salesChartInstance = null; // To destroy previous chart

        // ========== DOM ELEMENTS ==========
        const loginContainer = document.getElementById('login-container');
        const dashboardContainer = document.getElementById('dashboard-container');
        const loginError = document.getElementById('login-error');
        const contentArea = document.getElementById('content-area');
        const adminEmailSpan = document.getElementById('admin-email-display');
        const adminHeader = document.getElementById('adminHeader');
        const headerPlaceholder = document.getElementById('headerPlaceholder');

        // ========== SCROLL HEADER HIDE/SHOW (inverted) ==========
        let lastScrollTop = 0;
        // Set placeholder height based on header's actual height
        function updatePlaceholderHeight() {
            if (adminHeader && headerPlaceholder) {
                headerPlaceholder.style.height = adminHeader.offsetHeight + 'px';
            }
        }
        window.addEventListener('load', updatePlaceholderHeight);
        window.addEventListener('resize', updatePlaceholderHeight);

        window.addEventListener('scroll', () => {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const direction = scrollTop > lastScrollTop ? 'down' : 'up';
            
            if (direction === 'up') {
                // Scrolling up ‚Üí show completely
                adminHeader.classList.remove('half-hidden');
            } else if (direction === 'down') {
                // Scrolling down ‚Üí hide 50%
                adminHeader.classList.add('half-hidden');
            }
            
            lastScrollTop = scrollTop;
        });

        // ========== HEADER RESIZE OBSERVER (fixes placeholder height) ==========
        function initHeaderResizeObserver() {
            const header = document.getElementById('adminHeader');
            const placeholder = document.getElementById('headerPlaceholder');
            if (!header || !placeholder) return;

            // Set initial height
            placeholder.style.height = header.offsetHeight + 'px';

            // Use ResizeObserver to detect any future size changes
            if (window.ResizeObserver) {
                const observer = new ResizeObserver(entries => {
                    for (let entry of entries) {
                        placeholder.style.height = entry.contentRect.height + 'px';
                    }
                });
                observer.observe(header);
            } else {
                // Fallback for older browsers
                window.addEventListener('resize', () => {
                    placeholder.style.height = header.offsetHeight + 'px';
                });
            }
        }

        // ========== AUTH & LOGIN ==========
        document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            loginError.textContent = '';

            const { data, error } = await supabaseAdmin.auth.signInWithPassword({ email, password });
            if (error) {
                loginError.textContent = 'Invalid email or password';
                return;
            }
            await checkUserAndRedirect(data.user);
        });

        async function checkUserAndRedirect(user) {
            if (!user) return;

            const { data: profile, error } = await supabaseAdmin
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .maybeSingle();

            if (error) {
                loginError.textContent = `Error fetching profile: ${error.message}`;
                await supabaseAdmin.auth.signOut();
                return;
            }

            if (!profile) {
                loginError.textContent = 
                    'No profile found. This usually means the automatic profile creation trigger did not run.\n' +
                    'Please run the following SQL in your Supabase SQL editor:\n\n' +
                    `INSERT INTO public.profiles (id, email, full_name, phone, role)\n` +
                    `VALUES ('${user.id}', '${user.email}', NULL, NULL, 'super_admin')\n` +
                    `ON CONFLICT (id) DO NOTHING;` +
                    `\n\n(If you need a different admin role, use one of: super_admin, content_manager, support_staff)`;
                await supabaseAdmin.auth.signOut();
                return;
            }

            const adminRoles = ['super_admin', 'content_manager', 'support_staff'];
            if (!adminRoles.includes(profile.role)) {
                loginError.textContent = 
                    `Access denied. Your role is '${profile.role}', but admin privileges (${adminRoles.join(', ')}) are required.\n` +
                    `If you should be an admin, run this SQL:\n\n` +
                    `UPDATE public.profiles SET role = 'super_admin' WHERE id = '${user.id}';` +
                    `\n(Replace 'super_admin' with another role if needed.)`;
                await supabaseAdmin.auth.signOut();
                return;
            }

            currentUser = user;
            currentAdminProfile = profile;
            adminEmailSpan.textContent = profile.email || user.email;
            loginContainer.style.display = 'none';
            dashboardContainer.style.display = 'block';

            // üîÅ Initialise header observer now that dashboard is visible
            initHeaderResizeObserver();

            await loadSection('dashboard');
        }

        // ========== SIGN-UP FUNCTIONALITY ==========
        function toggleAuthMode(mode) {
            document.getElementById('login-form-block').style.display = mode === 'login' ? 'block' : 'none';
            document.getElementById('signup-form-block').style.display = mode === 'signup' ? 'block' : 'none';
        }

        document.getElementById('admin-signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('signup-name').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const phone = document.getElementById('signup-phone').value.trim();
            const password = document.getElementById('signup-password').value.trim();
            const confirm = document.getElementById('signup-confirm').value.trim();
            const errorEl = document.getElementById('signup-error');

            if (password !== confirm) {
                errorEl.textContent = 'Passwords do not match.';
                return;
            }

            errorEl.textContent = '';

            const { data, error } = await supabaseAdmin.auth.signUp({
                email,
                password,
                options: {
                    data: { full_name: name, phone: phone }
                }
            });

            if (error) {
                errorEl.textContent = error.message;
                return;
            }

            alert('Sign-up successful! You can now log in (admin privileges are required to access the dashboard).');
            toggleAuthMode('login');
            document.getElementById('signup-name').value = '';
            document.getElementById('signup-email').value = '';
            document.getElementById('signup-phone').value = '';
            document.getElementById('signup-password').value = '';
            document.getElementById('signup-confirm').value = '';
        });

        // Check existing session on page load
        supabaseAdmin.auth.getSession().then(({ data: { session } }) => {
            if (session?.user) {
                checkUserAndRedirect(session.user);
            }
        });

        supabaseAdmin.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT') {
                currentUser = null;
                currentAdminProfile = null;
                dashboardContainer.style.display = 'none';
                loginContainer.style.display = 'flex';
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';
                loginError.textContent = '';
            }
        });

        async function handleLogout() {
            await supabaseAdmin.auth.signOut();
        }

        // ========== HELPER FUNCTIONS ==========
        function showMessage(msg, isError = false) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.background = isError ? 'var(--brand-red)' : 'linear-gradient(145deg, var(--brand-red), #b0121e)';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function setActiveMenu(menuId) {
            document.querySelectorAll('.sidebar li').forEach(li => li.classList.remove('active'));
            const el = document.getElementById(`menu-${menuId}`);
            if (el) el.classList.add('active');
        }

        // ========== LOAD DIFFERENT SECTIONS ==========
        async function loadSection(section) {
            setActiveMenu(section);
            if (section === 'dashboard') {
                await renderDashboardOverview();
            } else if (section === 'categories') {
                await renderCategoriesSection();
            } else if (section === 'products') {
                await renderProductsSection();
            } else if (section === 'orders') {
                await renderOrdersSection();
            } else if (section === 'order_items') {
                await renderOrderItemsSection();
            } else if (section === 'promotions') {
                await renderPromotionsSection();
            } else if (section === 'bundles') {
                await renderBundlesSection();
            } else if (section === 'reviews') {
                await renderReviewsSection();
            } else if (section === 'settings') {
                await renderSettingsSection();
            } else if (section === 'users') {
                await renderUsersSection();
            } else if (section === 'contactSettings') {
                await renderContactSettings();
            } else if (section === 'locationSettings') {
                await renderLocationSettings();
            }
        }

        // ---------- DASHBOARD OVERVIEW (UPDATED WITH SALES GRAPH) ----------
        async function renderDashboardOverview() {
            contentArea.innerHTML = `<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i> Loading stats...</div>`;

            // Fetch basic counts (same as before)
            const { count: productsCount } = await supabaseAdmin.from('products').select('*', { count: 'exact', head: true });
            const { count: ordersCount } = await supabaseAdmin.from('orders').select('*', { count: 'exact', head: true });
            const { count: usersCount } = await supabaseAdmin.from('profiles').select('*', { count: 'exact', head: true }).not('role', 'in', '("super_admin","content_manager","support_staff")');
            const { data: revenueData } = await supabaseAdmin.from('orders').select('total').eq('status', 'delivered');
            const totalRevenue = revenueData?.reduce((sum, o) => sum + o.total, 0) || 0;
            const { data: recentOrders } = await supabaseAdmin.from('orders').select('*').order('created_at', { ascending: false }).limit(5);

            // Build the dashboard HTML with new Sales Overview section (graph + hidden table for data)
            let html = `
                <h2 class="section-title"><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card"><span class="label">Products</span><div class="value">${productsCount || 0}</div></div>
                    <div class="stat-card"><span class="label">Orders</span><div class="value">${ordersCount || 0}</div></div>
                    <div class="stat-card"><span class="label">Customers</span><div class="value">${usersCount || 0}</div></div>
                    <div class="stat-card"><span class="label">Revenue (Delivered)</span><div class="value">UGX ${totalRevenue.toLocaleString()}</div></div>
                </div>

                <!-- ===== NEW SALES OVERVIEW SECTION WITH GRAPH ===== -->
                <div style="margin-top: 40px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h3 style="color: var(--brand-blue); margin:0;"><i class="fas fa-chart-line"></i> Sales Overview</h3>
                        <div class="sales-range-selector">
                            <label for="sales-range">Period:</label>
                            <select id="sales-range" onchange="updateSalesGraph(this.value)">
                                <option value="7days" selected>Last 7 Days</option>
                                <option value="month">This Month</option>
                                <option value="year">This Year</option>
                            </select>
                        </div>
                    </div>
                    <!-- Chart container -->
                    <div id="sales-chart-container" class="chart-container">
                        <canvas id="salesChart"></canvas>
                    </div>
                    <!-- Optional small table for exact numbers (can be hidden if not needed) -->
                    <div id="sales-table-container" class="table-responsive" style="margin-top:20px; display:none;"></div>
                </div>

                <h3 style="color: var(--brand-blue); margin-bottom: 15px; margin-top: 40px;">Recent Orders</h3>
                <div class="table-responsive">
                    <table>
                        <thead><tr><th>Order ID</th><th>Customer</th><th>Total</th><th>Status</th><th>Date</th></tr></thead>
                        <tbody>
                            ${recentOrders?.map(o => `
                                <tr>
                                    <td>${o.order_id}</td>
                                    <td>${o.customer_name}</td>
                                    <td>UGX ${o.total.toLocaleString()}</td>
                                    <td><span class="badge ${o.status}">${o.status}</span></td>
                                    <td>${new Date(o.created_at).toLocaleDateString()}</td>
                                </tr>
                            `).join('') || '<tr><td colspan="5">No orders yet</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;

            contentArea.innerHTML = html;

            // Now load the initial sales graph (default 7 days)
            await updateSalesGraph('7days');
        }

        // New helper: load sales data based on range and render a bar chart
        async function updateSalesGraph(range) {
            const canvas = document.getElementById('salesChart');
            if (!canvas) return;

            // Show loading state
            const container = document.getElementById('sales-chart-container');
            container.innerHTML = '<div class="text-center" style="padding: 30px;"><i class="fas fa-spinner fa-spin"></i> Loading sales data...</div>';

            // Calculate start date based on range
            const now = new Date();
            let startDate;
            if (range === '7days') {
                startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            } else if (range === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            } else if (range === 'year') {
                startDate = new Date(now.getFullYear(), 0, 1);
            }

            // Fetch delivered orders from startDate to now
            const { data: orders, error } = await supabaseAdmin
                .from('orders')
                .select('created_at, total')
                .eq('status', 'delivered')
                .gte('created_at', startDate.toISOString())
                .lte('created_at', now.toISOString());

            if (error) {
                container.innerHTML = `<div class="error-message">Error loading sales: ${error.message}</div>`;
                return;
            }

            // Aggregate by day
            const salesByDate = new Map();
            orders.forEach(order => {
                const dateStr = new Date(order.created_at).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }); // e.g., "03 Feb"
                const total = order.total;
                salesByDate.set(dateStr, (salesByDate.get(dateStr) || 0) + total);
            });

            // Convert to array and sort by date (oldest first)
            const sortedEntries = Array.from(salesByDate.entries()).sort((a, b) => {
                const parseDate = (str) => {
                    const [day, month] = str.split(' ');
                    const monthIndex = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'].indexOf(month);
                    return new Date(now.getFullYear(), monthIndex, parseInt(day)).getTime();
                };
                return parseDate(a[0]) - parseDate(b[0]);
            });

            // If no data, show message
            if (sortedEntries.length === 0) {
                container.innerHTML = `<div class="text-center" style="padding: 30px;">No sales data for this period.</div>`;
                return;
            }

            // Prepare chart data
            const labels = sortedEntries.map(entry => entry[0]);
            const data = sortedEntries.map(entry => entry[1]);

            // Re-create canvas inside container
            container.innerHTML = '<canvas id="salesChart"></canvas>';
            const newCanvas = document.getElementById('salesChart');

            // Destroy previous chart instance if exists
            if (salesChartInstance) {
                salesChartInstance.destroy();
            }

            // Create new chart
            const ctx = newCanvas.getContext('2d');
            salesChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Sales (UGX)',
                        data: data,
                        backgroundColor: 'rgba(228, 30, 43, 0.7)',
                        borderColor: 'rgba(228, 30, 43, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `UGX ${context.raw.toLocaleString()}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => 'UGX ' + value.toLocaleString()
                            }
                        }
                    }
                }
            });
        }

        // ---------- CATEGORIES MANAGEMENT ----------
        async function renderCategoriesSection() {
            contentArea.innerHTML = `<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i> Loading categories...</div>`;
            const { data: categories } = await supabaseAdmin.from('categories').select('*').order('id');
            let html = `
                <div class="section-title">
                    <span><i class="fas fa-tags"></i> Categories</span>
                    <button onclick="showAddCategoryForm()" class="btn-sm"><i class="fas fa-plus"></i> Add Category</button>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead><tr><th>ID</th><th>Slug</th><th>Name</th><th>Display Name</th><th>Image</th><th>Description</th><th>Actions</th></tr></thead>
                        <tbody>
                            ${categories?.map(c => `
                                <tr>
                                    <td>${c.id}</td>
                                    <td><code>${c.slug || ''}</code></td>
                                    <td>${c.name}</td>
                                    <td>${c.display_name}</td>
                                    <td>${c.image || '‚Äî'}</td>
                                    <td>${c.description || ''}</td>
                                    <td class="action-group">
                                        <button onclick="editCategory(${c.id})" class="btn-sm"><i class="fas fa-edit"></i></button>
                                        <button onclick="deleteCategory(${c.id})" class="btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `).join('') || '<tr><td colspan="7">No categories</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
            contentArea.innerHTML = html;
        }

        async function showAddCategoryForm() {
            const formHtml = `
                <div class="form-container">
                    <h3 style="color:var(--brand-red);">‚ûï Add Category</h3>
                    <form onsubmit="saveCategory(event)">
                        <div class="form-group">
                            <label>Slug (unique, URL-friendly) *</label>
                            <input type="text" name="slug" class="form-control" placeholder="e.g., smartphones" required>
                        </div>
                        <div class="form-group">
                            <label>Name (internal) *</label>
                            <input type="text" name="name" class="form-control" placeholder="smartphones" required>
                        </div>
                        <div class="form-group">
                            <label>Display Name *</label>
                            <input type="text" name="display_name" class="form-control" placeholder="SMARTPHONES" required>
                        </div>
                        <div class="form-group">
                            <label>Image (emoji or URL)</label>
                            <input type="text" name="image" class="form-control" placeholder="üì± or https://...">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea name="description" rows="2" class="form-control"></textarea>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button type="submit" class="btn-sm">Save Category</button>
                            <button type="button" onclick="renderCategoriesSection()" class="btn-sm" style="background:#6c757d;">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            contentArea.innerHTML = formHtml;
        }

        async function editCategory(categoryId) {
            const { data: cat } = await supabaseAdmin.from('categories').select('*').eq('id', categoryId).single();
            if (!cat) return;
            const formHtml = `
                <div class="form-container">
                    <h3 style="color:var(--brand-red);">‚úèÔ∏è Edit Category</h3>
                    <form onsubmit="updateCategory(event, ${cat.id})">
                        <div class="form-group">
                            <label>Slug *</label>
                            <input type="text" name="slug" value="${cat.slug || ''}" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Name *</label>
                            <input type="text" name="name" value="${cat.name}" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Display Name *</label>
                            <input type="text" name="display_name" value="${cat.display_name}" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Image (emoji or URL)</label>
                            <input type="text" name="image" value="${cat.image || ''}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea name="description" rows="2" class="form-control">${cat.description || ''}</textarea>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button type="submit" class="btn-sm">Update Category</button>
                            <button type="button" onclick="renderCategoriesSection()" class="btn-sm" style="background:#6c757d;">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            contentArea.innerHTML = formHtml;
        }

        async function saveCategory(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const category = {
                slug: formData.get('slug'),
                name: formData.get('name'),
                display_name: formData.get('display_name'),
                image: formData.get('image') || null,
                description: formData.get('description') || null
            };
            const { error } = await supabaseAdmin.from('categories').insert(category);
            if (error) showMessage('Error: ' + error.message, true);
            else { showMessage('Category added!'); renderCategoriesSection(); }
        }

        async function updateCategory(e, id) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const category = {
                slug: formData.get('slug'),
                name: formData.get('name'),
                display_name: formData.get('display_name'),
                image: formData.get('image') || null,
                description: formData.get('description') || null
            };
            const { error } = await supabaseAdmin.from('categories').update(category).eq('id', id);
            if (error) showMessage('Error: ' + error.message, true);
            else { showMessage('Category updated!'); renderCategoriesSection(); }
        }

        async function deleteCategory(id) {
            if (!confirm('Delete this category? Products in it will have category set to NULL.')) return;
            const { error } = await supabaseAdmin.from('categories').delete().eq('id', id);
            if (error) showMessage('Error: ' + error.message, true);
            else { showMessage('Category deleted.'); renderCategoriesSection(); }
        }

        // ---------- PRODUCTS MANAGEMENT ----------
        async function renderProductsSection() {
            contentArea.innerHTML = `<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i> Loading products...</div>`;
            const { data: products } = await supabaseAdmin.from('products').select('*, categories(name)').order('id');
            const { data: cats } = await supabaseAdmin.from('categories').select('*').neq('name', 'all').order('id');
            categoriesCache = cats || [];

            let html = `
                <div class="section-title">
                    <span><i class="fas fa-mobile-alt"></i> Manage Products</span>
                    <button onclick="showAddProductForm()" class="btn-sm"><i class="fas fa-plus"></i> Add New Product</button>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr><th>ID</th><th>Name</th><th>Category</th><th>Price</th><th>Discount%</th><th>Stock</th><th>Actions</th></tr>
                        </thead>
                        <tbody>
                            ${products?.map(p => `
                                <tr>
                                    <td>${p.id}</td>
                                    <td>${p.name}</td>
                                    <td>${p.categories?.display_name || ''}</td>
                                    <td>UGX ${p.price.toLocaleString()}</td>
                                    <td>${p.discount || 0}%</td>
                                    <td>${p.stock}</td>
                                    <td class="action-group">
                                        <button onclick="editProduct(${p.id})" class="btn-sm" style="background:var(--brand-blue);"><i class="fas fa-edit"></i> Edit</button>
                                        <button onclick="deleteProduct(${p.id})" class="btn-sm btn-danger"><i class="fas fa-trash"></i> Delete</button>
                                    </td>
                                </tr>
                            `).join('') || '<tr><td colspan="7">No products found</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
            contentArea.innerHTML = html;
        }

        async function showAddProductForm() {
            if (categoriesCache.length === 0) {
                const { data } = await supabaseAdmin.from('categories').select('*').neq('name', 'all').order('id');
                categoriesCache = data || [];
            }
            const catOptions = categoriesCache.map(c => `<option value="${c.id}">${c.display_name}</option>`).join('');
            const formHtml = `
                <div class="form-container">
                    <h3 style="color:var(--brand-red); margin-bottom:20px;">‚ûï Add New Product</h3>
                    <form id="product-form" onsubmit="saveProduct(event)">
                        <div class="form-group">
                            <label>Product Name *</label>
                            <input type="text" name="name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Category *</label>
                            <select name="category_id" class="form-control" required>${catOptions}</select>
                        </div>
                        <div class="form-group">
                            <label>Brand</label>
                            <input type="text" name="brand" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Specifications</label>
                            <input type="text" name="specs" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Price (UGX) *</label>
                            <input type="number" name="price" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Original Price (UGX) ‚Äì leave 0 if no discount</label>
                            <input type="number" name="original_price" class="form-control" value="0">
                        </div>
                        <div class="form-group">
                            <label>Stock *</label>
                            <input type="number" name="stock" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Rating (0-5)</label>
                            <input type="number" step="0.1" name="rating" class="form-control" value="0">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea name="description" rows="2" class="form-control"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Image URLs (comma separated)</label>
                            <input type="text" name="images" class="form-control" placeholder="https://... , https://...">
                        </div>
                        <div class="form-group">
                            <label>Urgency Badge (e.g. 'üö® Limited stock!')</label>
                            <input type="text" name="urgency" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Warranty Info</label>
                            <input type="text" name="warranty" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Popularity (number bought)</label>
                            <input type="number" name="popularity" class="form-control" value="0">
                        </div>
                        <div style="display:flex; gap:10px; margin-top:20px;">
                            <button type="submit" class="btn-sm" style="background: var(--success);">üíæ Save Product</button>
                            <button type="button" onclick="renderProductsSection()" class="btn-sm" style="background: #6c757d;">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            contentArea.innerHTML = formHtml;
        }

        async function editProduct(productId) {
            const { data: product } = await supabaseAdmin.from('products').select('*').eq('id', productId).single();
            if (!product) return;
            if (categoriesCache.length === 0) {
                const { data } = await supabaseAdmin.from('categories').select('*').neq('name', 'all').order('id');
                categoriesCache = data || [];
            }
            const catOptions = categoriesCache.map(c => `<option value="${c.id}" ${c.id === product.category_id ? 'selected' : ''}>${c.display_name}</option>`).join('');
            const imagesStr = product.images ? product.images.join(', ') : '';
            const formHtml = `
                <div class="form-container">
                    <h3 style="color:var(--brand-red); margin-bottom:20px;">‚úèÔ∏è Edit Product (ID: ${product.id})</h3>
                    <form id="product-form" onsubmit="updateProduct(event, ${product.id})">
                        <div class="form-group">
                            <label>Product Name *</label>
                            <input type="text" name="name" value="${product.name.replace(/"/g, '&quot;')}" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Category *</label>
                            <select name="category_id" class="form-control" required>${catOptions}</select>
                        </div>
                        <div class="form-group">
                            <label>Brand</label>
                            <input type="text" name="brand" value="${product.brand || ''}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Specifications</label>
                            <input type="text" name="specs" value="${product.specs || ''}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Price (UGX) *</label>
                            <input type="number" name="price" value="${product.price}" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Original Price (UGX)</label>
                            <input type="number" name="original_price" value="${product.original_price || 0}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Stock *</label>
                            <input type="number" name="stock" value="${product.stock}" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Rating (0-5)</label>
                            <input type="number" step="0.1" name="rating" value="${product.rating || 0}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea name="description" rows="2" class="form-control">${product.description || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Image URLs (comma separated)</label>
                            <input type="text" name="images" value="${imagesStr}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Urgency Badge</label>
                            <input type="text" name="urgency" value="${product.urgency || ''}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Warranty Info</label>
                            <input type="text" name="warranty" value="${product.warranty || ''}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Popularity</label>
                            <input type="number" name="popularity" value="${product.popularity || 0}" class="form-control">
                        </div>
                        <div style="display:flex; gap:10px; margin-top:20px;">
                            <button type="submit" class="btn-sm" style="background: var(--success);">‚úÖ Update Product</button>
                            <button type="button" onclick="renderProductsSection()" class="btn-sm" style="background: #6c757d;">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            contentArea.innerHTML = formHtml;
        }

        async function saveProduct(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const images = formData.get('images') ? formData.get('images').split(',').map(s => s.trim()) : [];
            const product = {
                category_id: parseInt(formData.get('category_id')),
                brand: formData.get('brand') || null,
                name: formData.get('name'),
                specs: formData.get('specs') || null,
                price: parseInt(formData.get('price')),
                original_price: formData.get('original_price') ? parseInt(formData.get('original_price')) : null,
                stock: parseInt(formData.get('stock')),
                rating: parseFloat(formData.get('rating')) || 0,
                description: formData.get('description') || null,
                images: images.length ? images : null,
                urgency: formData.get('urgency') || null,
                warranty: formData.get('warranty') || null,
                popularity: parseInt(formData.get('popularity')) || 0,
                updated_at: new Date()
            };
            if (product.original_price === 0) product.original_price = null;
            const { error } = await supabaseAdmin.from('products').insert(product);
            if (error) showMessage('Error: ' + error.message, true);
            else { showMessage('Product added successfully!'); renderProductsSection(); }
        }

        async function updateProduct(e, id) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const images = formData.get('images') ? formData.get('images').split(',').map(s => s.trim()) : [];
            const product = {
                category_id: parseInt(formData.get('category_id')),
                brand: formData.get('brand') || null,
                name: formData.get('name'),
                specs: formData.get('specs') || null,
                price: parseInt(formData.get('price')),
                original_price: formData.get('original_price') ? parseInt(formData.get('original_price')) : null,
                stock: parseInt(formData.get('stock')),
                rating: parseFloat(formData.get('rating')) || 0,
                description: formData.get('description') || null,
                images: images.length ? images : null,
                urgency: formData.get('urgency') || null,
                warranty: formData.get('warranty') || null,
                popularity: parseInt(formData.get('popularity')) || 0,
                updated_at: new Date()
            };
            if (product.original_price === 0) product.original_price = null;
            const { error } = await supabaseAdmin.from('products').update(product).eq('id', id);
            if (error) showMessage('Error: ' + error.message, true);
            else { showMessage('Product updated!'); renderProductsSection(); }
        }

        async function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product?')) return;
            const { error } = await supabaseAdmin.from('products').delete().eq('id', id);
            if (error) showMessage('Error: ' + error.message, true);
            else { showMessage('Product deleted.'); renderProductsSection(); }
        }

        // ---------- UPDATED ORDERS MANAGEMENT ----------
        async function renderOrdersSection() {
            contentArea.innerHTML = `<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i> Loading orders...</div>`;
            const { data: orders, error } = await supabaseAdmin.from('orders').select('*').order('created_at', { ascending: false });

            if (error) {
                contentArea.innerHTML = `<div class="error-message">Error loading orders: ${error.message}</div>`;
                return;
            }

            let html = `
                <h2 class="section-title"><i class="fas fa-shopping-cart"></i> Manage Orders</h2>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Address</th>
                                <th>Subtotal</th>
                                <th>Shipping</th>
                                <th>Discount</th>
                                <th>Total</th>
                                <th>Payment</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${orders?.map(o => `
                                <tr>
                                    <td>${o.order_id}</td>
                                    <td>${o.customer_name}<br><small>${o.customer_phone}</small></td>
                                    <td>${o.customer_address || ''}</td>
                                    <td>UGX ${o.subtotal?.toLocaleString()}</td>
                                    <td>UGX ${o.shipping?.toLocaleString()}</td>
                                    <td>UGX ${o.discount?.toLocaleString()}</td>
                                    <td>UGX ${o.total?.toLocaleString()}</td>
                                    <td>${o.payment_method}</td>
                                    <td><span class="badge ${o.status}">${o.status}</span></td>
                                    <td>${new Date(o.created_at).toLocaleDateString()}</td>
                                    <td>
                                        <select onchange="updateOrderStatus(${o.id}, this.value)" class="form-control" style="width:130px;">
                                            <option value="pending" ${o.status === 'pending' ? 'selected' : ''}>Pending</option>
                                            <option value="confirmed" ${o.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                            <option value="delivered" ${o.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                                            <option value="cancelled" ${o.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                        </select>
                                    </td>
                                </tr>
                            `).join('') || '<tr><td colspan="11">No orders found</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
            contentArea.innerHTML = html;
        }

        // Modified: when status is "cancelled", delete the order after confirmation
        async function updateOrderStatus(orderId, status) {
            if (status === 'cancelled') {
                if (!confirm('Are you sure you want to cancel and permanently delete this order?')) {
                    return;
                }
                // Delete the order
                const { error } = await supabaseAdmin.from('orders').delete().eq('id', orderId);
                if (error) {
                    showMessage('Error deleting order: ' + error.message, true);
                } else {
                    showMessage('Order cancelled and deleted.');
                    renderOrdersSection();
                }
            } else {
                // Normal status update
                const { error } = await supabaseAdmin.from('orders').update({ status }).eq('id', orderId);
                if (error) showMessage('Error updating status', true);
                else { showMessage('Order status updated'); renderOrdersSection(); }
            }
        }

        // ---------- UPDATED ORDER ITEMS MANAGEMENT ----------
        async function renderOrderItemsSection() {
            contentArea.innerHTML = `<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i> Loading order items...</div>`;
            const { data: items, error } = await supabaseAdmin.from('order_items').select('*').order('id', { ascending: false });

            if (error) {
                contentArea.innerHTML = `<div class="error-message">Error loading order items: ${error.message}</div>`;
                return;
            }

            let html = `
                <h2 class="section-title"><i class="fas fa-list-ul"></i> Order Items</h2>
                <div class="table-responsive">
                    <table>
                        <thead><tr><th>Order ID</th><th>Product Name</th><th>Brand</th><th>Specs</th><th>Quantity</th><th>Price</th><th>Image</th></tr></thead>
                        <tbody>
                            ${items?.map(i => `
                                <tr>
                                    <td>${i.order_id}</td>
                                    <td>${i.product_name}</td>
                                    <td>${i.brand || '‚Äî'}</td>
                                    <td>${i.specs || ''}</td>
                                    <td>${i.quantity}</td>
                                    <td>UGX ${i.price.toLocaleString()}</td>
                                    <td>${i.image ? 'üì∑' : '‚Äî'}</td>
                                </tr>
                            `).join('') || '<tr><td colspan="7">No order items found</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
            contentArea.innerHTML = html;
        }

        // ========== ENHANCED PROMOTIONS MANAGEMENT WITH PROMO ROTATOR ==========
        async function renderPromotionsSection() {
            contentArea.innerHTML = `<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i> Loading promotions...</div>`;
            
            // Fetch both promo codes and promo rotator items
            const [{ data: promos }, { data: promoRotator }] = await Promise.all([
                supabaseAdmin.from('promotions').select('*, categories(display_name)').order('id'),
                supabaseAdmin.from('promo_rotator').select('*').order('sort_order')
            ]);
            
            let html = `
                <h2 class="section-title"><i class="fas fa-tags"></i> Promotions Management</h2>
                
                <!-- Promo Codes Section -->
                <div style="margin-bottom: 50px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--brand-blue);"><i class="fas fa-code"></i> Promo Codes</h3>
                        <button onclick="showAddPromoForm()" class="btn-sm"><i class="fas fa-plus"></i> Add Promo Code</button>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Type</th>
                                    <th>Value</th>
                                    <th>Min Order</th>
                                    <th>Category</th>
                                    <th>Valid Until</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${promos?.map(p => `
                                    <tr>
                                        <td><code>${p.code}</code></td>
                                        <td>${p.type}</td>
                                        <td>${p.type === 'percentage' ? p.value + '%' : p.type === 'fixed' ? 'UGX ' + p.value.toLocaleString() : p.type}</td>
                                        <td>UGX ${p.min_order?.toLocaleString() || 0}</td>
                                        <td>${p.categories?.display_name || 'All'}</td>
                                        <td>${p.valid_until ? new Date(p.valid_until).toLocaleDateString() : 'No expiry'}</td>
                                        <td>${p.description || ''}</td>
                                        <td class="action-group">
                                            <button onclick="editPromo(${p.id})" class="btn-sm"><i class="fas fa-edit"></i></button>
                                            <button onclick="deletePromo(${p.id})" class="btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                `).join('') || '<tr><td colspan="8">No promo codes found</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Promo Rotator Section -->
                <div style="margin-top: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--brand-blue);"><i class="fas fa-images"></i> Promo Rotator (Homepage Banners)</h3>
                        <button onclick="showAddPromoRotatorForm()" class="btn-sm"><i class="fas fa-plus"></i> Add New Banner</button>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Order</th>
                                    <th>Icon</th>
                                    <th>Title</th>
                                    <th>Description</th>
                                    <th>Gradient</th>
                                    <th>Image</th>
                                    <th>Button</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${promoRotator?.map(r => `
                                    <tr>
                                        <td>${r.sort_order || 0}</td>
                                        <td style="font-size: 24px;">${r.icon || 'üéÅ'}</td>
                                        <td>${r.title}</td>
                                        <td>${r.description || ''}</td>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 5px;">
                                                <div style="width: 20px; height: 20px; background: ${r.gradient_start || '#e41e2b'}; border-radius: 4px;"></div>
                                                <div style="width: 20px; height: 20px; background: ${r.gradient_end || '#1a5fb4'}; border-radius: 4px;"></div>
                                                <div style="width: 30px; height: 20px; background: linear-gradient(45deg, ${r.gradient_start || '#e41e2b'}, ${r.gradient_end || '#1a5fb4'}); border-radius: 4px;"></div>
                                            </div>
                                        </td>
                                        <td>
                                            ${r.image_url ? `<img src="${r.image_url}" style="width:50px; height:30px; object-fit:cover; border-radius:4px;" onerror="this.style.display='none'">` : '‚Äî'}
                                        </td>
                                        <td>
                                            ${r.button_text ? `<span class="badge" style="background:var(--brand-blue); color:white;">${r.button_text}</span>` : '‚Äî'}
                                        </td>
                                        <td>
                                            <span class="badge" style="background: ${r.is_active ? '#d4edda' : '#f8d7da'}; color: ${r.is_active ? '#155724' : '#721c24'};">
                                                ${r.is_active ? 'Active' : 'Inactive'}
                                            </span>
                                        </td>
                                        <td class="action-group">
                                            <button onclick="editPromoRotator(${r.id})" class="btn-sm"><i class="fas fa-edit"></i></button>
                                            <button onclick="deletePromoRotator(${r.id})" class="btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                `).join('') || '<tr><td colspan="9">No promo banners found</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            contentArea.innerHTML = html;
        }

        // ========== PROMO ROTATOR FUNCTIONS ==========
        async function showAddPromoRotatorForm() {
            const formHtml = `
                <div class="form-container" style="max-width:800px;">
                    <h3 style="color:var(--brand-red); margin-bottom:20px;">‚ûï Add New Promo Banner</h3>
                    <form onsubmit="savePromoRotator(event)">
                        <div class="form-group">
                            <label>Title *</label>
                            <input type="text" name="title" class="form-control" placeholder="e.g., Holiday Special Sale!" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Description</label>
                            <textarea name="description" rows="2" class="form-control" placeholder="Limited time offer..."></textarea>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Gradient Start Color</label>
                                <input type="color" name="gradient_start" class="form-control" value="#e41e2b" style="height: 50px;">
                            </div>
                            <div class="form-group">
                                <label>Gradient End Color</label>
                                <input type="color" name="gradient_end" class="form-control" value="#1a5fb4" style="height: 50px;">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Icon (emoji or FontAwesome class)</label>
                            <input type="text" name="icon" class="form-control" placeholder="üéÅ or fas fa-gift" value="üéÅ">
                        </div>
                        
                        <div class="form-group">
                            <label>Background Image URL</label>
                            <input type="url" name="image_url" class="form-control" placeholder="https://example.com/image.jpg">
                            <small style="color:#666;">Leave empty to use gradient only</small>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Button Text (optional)</label>
                                <input type="text" name="button_text" class="form-control" placeholder="Shop Now">
                            </div>
                            <div class="form-group">
                                <label>Button Link (optional)</label>
                                <input type="url" name="button_link" class="form-control" placeholder="https://example.com/shop">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Sort Order</label>
                                <input type="number" name="sort_order" class="form-control" value="0" min="0">
                                <small>Lower numbers appear first</small>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select name="is_active" class="form-control">
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display:flex; gap:10px; margin-top:30px;">
                            <button type="submit" class="btn-sm" style="background: var(--success);">üíæ Save Banner</button>
                            <button type="button" onclick="renderPromotionsSection()" class="btn-sm" style="background:#6c757d;">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            contentArea.innerHTML = formHtml;
        }

        async function editPromoRotator(bannerId) {
            const { data: banner } = await supabaseAdmin.from('promo_rotator').select('*').eq('id', bannerId).single();
            if (!banner) return;
            
            const formHtml = `
                <div class="form-container" style="max-width:800px;">
                    <h3 style="color:var(--brand-red); margin-bottom:20px;">‚úèÔ∏è Edit Promo Banner</h3>
                    <form onsubmit="updatePromoRotator(event, ${banner.id})">
                        <div class="form-group">
                            <label>Title *</label>
                            <input type="text" name="title" value="${banner.title.replace(/"/g, '&quot;')}" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Description</label>
                            <textarea name="description" rows="2" class="form-control">${banner.description || ''}</textarea>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Gradient Start Color</label>
                                <input type="color" name="gradient_start" class="form-control" value="${banner.gradient_start || '#e41e2b'}" style="height: 50px;">
                            </div>
                            <div class="form-group">
                                <label>Gradient End Color</label>
                                <input type="color" name="gradient_end" class="form-control" value="${banner.gradient_end || '#1a5fb4'}" style="height: 50px;">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Icon</label>
                            <input type="text" name="icon" value="${banner.icon || 'üéÅ'}" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label>Background Image URL</label>
                            <input type="url" name="image_url" value="${banner.image_url || ''}" class="form-control">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Button Text</label>
                                <input type="text" name="button_text" value="${banner.button_text || ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Button Link</label>
                                <input type="url" name="button_link" value="${banner.button_link || ''}" class="form-control">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Sort Order</label>
                                <input type="number" name="sort_order" value="${banner.sort_order || 0}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select name="is_active" class="form-control">
                                    <option value="true" ${banner.is_active ? 'selected' : ''}>Active</option>
                                    <option value="false" ${!banner.is_active ? 'selected' : ''}>Inactive</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display:flex; gap:10px; margin-top:30px;">
                            <button type="submit" class="btn-sm" style="background: var(--success);">‚úÖ Update Banner</button>
                            <button type="button" onclick="renderPromotionsSection()" class="btn-sm" style="background:#6c757d;">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            contentArea.innerHTML = formHtml;
        }

        async function savePromoRotator(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            const banner = {
                title: formData.get('title'),
                description: formData.get('description') || null,
                gradient_start: formData.get('gradient_start') || '#e41e2b',
                gradient_end: formData.get('gradient_end') || '#1a5fb4',
                icon: formData.get('icon') || 'üéÅ',
                image_url: formData.get('image_url') || null,
                button_text: formData.get('button_text') || null,
                button_link: formData.get('button_link') || null,
                sort_order: parseInt(formData.get('sort_order')) || 0,
                is_active: formData.get('is_active') === 'true'
            };
            
            const { error } = await supabaseAdmin.from('promo_rotator').insert(banner);
            if (error) showMessage('Error: ' + error.message, true);
            else { showMessage('Promo banner added successfully!'); renderPromotionsSection(); }
        }

        async function updatePromoRotator(e, id) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            const banner = {
                title: formData.get('title'),
                description: formData.get('description') || null,
                gradient_start: formData.get('gradient_start') || '#e41e2b',
                gradient_end: formData.get('gradient_end') || '#1a5fb4',
                icon: formData.get('icon') || 'üéÅ',
                image_url: formData.get('image_url') || null,
                button_text: formData.get('button_text') || null,
                button_link: formData.get('button_link') || null,
                sort_order: parseInt(formData.get('sort_order')) || 0,
                is_active: formData.get('is_active') === 'true'
            };
            
            const { error } = await supabaseAdmin.from('promo_rotator').update(banner).eq('id', id);
            if (error) showMessage('Error: ' + error.message, true);
            else { showMessage('Promo banner updated successfully!'); renderPromotionsSection(); }
        }

        async function deletePromoRotator(id) {
            if (!confirm('Delete this promo banner?')) return;
            const { error } = await supabaseAdmin.from('promo_rotator').delete().eq('id', id);
            if (error) showMessage('Error: ' + error.message, true);
            else { showMessage('Promo banner deleted.'); renderPromotionsSection(); }
        }

        // ---------- PROMO CODES FUNCTIONS ----------
        async function showAddPromoForm() {
            const { data: cats } = await supabaseAdmin.from('categories').select('*').neq('name', 'all');
            const catOptions = `<option value="">-- Any category --</option>` + cats.map(c => `<option value="${c.id}">${c.display_name}</option>`).join('');
            const formHtml = `
                <div class="form-container">
                    <h3 style="color:var(--brand-red);">‚ûï Add Promotion</h3>
                    <form onsubmit="savePromo(event)">
                        <div class="form-group">
                            <label>Promo Code *</label>
                            <input type="text" name="code" class="form-control" placeholder="e.g., SAVE20" required>
                        </div>
                        <div class="form-group">
                            <label>Type *</label>
                            <select name="type" class="form-control" required>
                                <option value="percentage">Percentage</option>
                                <option value="fixed">Fixed Amount</option>
                                <option value="free_shipping">Free Shipping</option>
                                <option value="bogo">Buy One Get One</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Value (for percentage/fixed)</label>
                            <input type="number" name="value" class="form-control" value="0">
                        </div>
                        <div class="form-group">
                            <label>Minimum Order (UGX)</label>
                            <input type="number" name="min_order" class="form-control" value="0">
                        </div>
                        <div class="form-group">
                            <label>Description *</label>
                            <input type="text" name="description" class="form-control" placeholder="e.g., 20% off on all items" required>
                        </div>
                        <div class="form-group">
                            <label>Valid Until (optional)</label>
                            <input type="date" name="valid_until" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Category Restriction</label>
                            <select name="category_id" class="form-control">${catOptions}</select>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button type="submit" class="btn-sm">Save Promo</button>
                            <button type="button" onclick="renderPromotionsSection()" class="btn-sm" style="background:#6c757d;">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            contentArea.innerHTML = formHtml;
        }

        async function editPromo(promoId) {
            const { data: promo } = await supabaseAdmin.from('promotions').select('*').eq('id', promoId).single();
            if (!promo) return;
            const { data: cats } = await supabaseAdmin.from('categories').select('*').neq('name', 'all');
            const catOptions = `<option value="">-- Any category --</option>` + cats.map(c => `<option value="${c.id}" ${c.id === promo.category_id ? 'selected' : ''}>${c.display_name}</option>`).join('');
            const formHtml = `
                <div class="form-container">
                    <h3 style="color:var(--brand-red);">‚úèÔ∏è Edit Promotion</h3>
                    <form onsubmit="updatePromo(event, ${promo.id})">
                        <div class="form-group">
                            <label>Promo Code *</label>
                            <input type="text" name="code" value="${promo.code}" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Type *</label>
                            <select name="type" class="form-control" required>
                                <option value="percentage" ${promo.type==='percentage'?'selected':''}>Percentage</option>
                                <option value="fixed" ${promo.type==='fixed'?'selected':''}>Fixed Amount</option>
                                <option value="free_shipping" ${promo.type==='free_shipping'?'selected':''}>Free Shipping</option>
                                <option value="bogo" ${promo.type==='bogo'?'selected':''}>Buy One Get One</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Value</label>
                            <input type="number" name="value" value="${promo.value || 0}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Minimum Order (UGX)</label>
                            <input type="number" name="min_order" value="${promo.min_order || 0}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Description *</label>
                            <input type="text" name="description" value="${promo.description ? promo.description.replace(/"/g, '&quot;') : ''}" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Valid Until</label>
                            <input type="date" name="valid_until" value="${promo.valid_until ? promo.valid_until.slice(0,10) : ''}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Category Restriction</label>
                            <select name="category_id" class="form-control">${catOptions}</select>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button type="submit" class="btn-sm">Update Promo</button>
                            <button type="button" onclick="renderPromotionsSection()" class="btn-sm" style="background:#6c757d;">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            contentArea.innerHTML = formHtml;
        }

        async function savePromo(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const promo = {
                code: formData.get('code').toUpperCase(),
                type: formData.get('type'),
                value: parseInt(formData.get('value')) || 0,
                min_order: parseInt(formData.get('min_order')) || 0,
                description: formData.get('description'),
                valid_until: formData.get('valid_until') || null,
                category_id: formData.get('category_id') ? parseInt(formData.get('category_id')) : null
            };
            const { error } = await supabaseAdmin.from('promotions').insert(promo);
            if (error) showMessage('Error: ' + error.message, true);
            else { showMessage('Promo added!'); renderPromotionsSection(); }
        }

        async function updatePromo(e, id) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const promo = {
                code: formData.get('code').toUpperCase(),
                type: formData.get('type'),
                value: parseInt(formData.get('value')) || 0,
                min_order: parseInt(formData.get('min_order')) || 0,
                description: formData.get('description'),
                valid_until: formData.get('valid_until') || null,
                category_id: formData.get('category_id') ? parseInt(formData.get('category_id')) : null
            };
            const { error } = await supabaseAdmin.from('promotions').update(promo).eq('id', id);
            if (error) showMessage('Error: ' + error.message, true);
            else { showMessage('Promo updated!'); renderPromotionsSection(); }
        }

        async function deletePromo(id) {
            if (!confirm('Delete this promotion?')) return;
            const { error } = await supabaseAdmin.from('promotions').delete().eq('id', id);
            if (error) showMessage('Error: ' + error.message, true);
            else { showMessage('Promo deleted.'); renderPromotionsSection(); }
        }

        // ========== BUNDLES MANAGEMENT (with user-friendly item rows) ==========
        async function renderBundlesSection() {
            contentArea.innerHTML = `<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i> Loading bundles...</div>`;
            const { data: bundles } = await supabaseAdmin.from('bundles').select('*').order('id');
            let html = `
                <div class="section-title">
                    <span><i class="fas fa-gift"></i> Bundle Deals</span>
                    <button onclick="showAddBundleForm()" class="btn-sm"><i class="fas fa-plus"></i> Add Bundle</button>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead><tr><th>Name</th><th>Total</th><th>Discounted</th><th>Save %</th><th>Items</th><th>Actions</th></tr></thead>
                        <tbody>
                            ${bundles?.map(b => `
                                <tr>
                                    <td>${b.name}</td>
                                    <td>UGX ${b.total.toLocaleString()}</td>
                                    <td>UGX ${b.discounted.toLocaleString()}</td>
                                    <td>${b.save_percent || 0}%</td>
                                    <td>${Array.isArray(b.items) ? b.items.length : 0} items</td>
                                    <td class="action-group">
                                        <button onclick="editBundle(${b.id})" class="btn-sm"><i class="fas fa-edit"></i></button>
                                        <button onclick="deleteBundle(${b.id})" class="btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `).join('') || '<tr><td colspan="6">No bundles</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
            contentArea.innerHTML = html;
        }

        // Helper to add a new item row in bundle form
        function addBundleItemRow(containerId, item = { name: '', price: 0, url: '' }) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const row = document.createElement('div');
            row.className = 'bundle-item-row';
            row.innerHTML = `
                <input type="text" placeholder="Product name" value="${item.name.replace(/"/g, '&quot;')}" class="form-control" style="flex:2;" required>
                <input type="number" placeholder="Price UGX" value="${item.price}" class="form-control" style="width:120px;" required>
                <input type="url" placeholder="Product URL (optional)" value="${item.url || ''}" class="form-control" style="flex:1.5;">
                <button type="button" class="btn-remove-item" onclick="this.parentElement.remove()">‚úñ</button>
            `;
            container.appendChild(row);
        }

        async function showAddBundleForm() {
            const formHtml = `
                <div class="form-container">
                    <h3 style="color:var(--brand-red);">‚ûï Add Bundle</h3>
                    <form onsubmit="saveBundle(event)">
                        <div class="form-group">
                            <label>Bundle Name *</label>
                            <input type="text" name="name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Total Original Price (UGX) *</label>
                            <input type="number" name="total" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Discounted Price (UGX) *</label>
                            <input type="number" name="discounted" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Save Percentage</label>
                            <input type="number" name="save_percent" class="form-control" value="0">
                        </div>
                        <div class="form-group">
                            <label>Bundle Items *</label>
                            <div id="bundle-items-container"></div>
                            <button type="button" onclick="addBundleItemRow('bundle-items-container')" class="btn-sm" style="margin-top:10px;"><i class="fas fa-plus"></i> Add Item</button>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:20px;">
                            <button type="submit" class="btn-sm" style="background: var(--success);">üíæ Save Bundle</button>
                            <button type="button" onclick="renderBundlesSection()" class="btn-sm" style="background:#6c757d;">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            contentArea.innerHTML = formHtml;
            // Add one empty row by default
            addBundleItemRow('bundle-items-container');
        }

        async function editBundle(bundleId) {
            const { data: bundle } = await supabaseAdmin.from('bundles').select('*').eq('id', bundleId).single();
            if (!bundle) return;
            
            const formHtml = `
                <div class="form-container">
                    <h3 style="color:var(--brand-red);">‚úèÔ∏è Edit Bundle</h3>
                    <form onsubmit="updateBundle(event, ${bundle.id})">
                        <div class="form-group">
                            <label>Bundle Name *</label>
                            <input type="text" name="name" value="${bundle.name.replace(/"/g, '&quot;')}" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Total Original Price (UGX) *</label>
                            <input type="number" name="total" value="${bundle.total}" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Discounted Price (UGX) *</label>
                            <input type="number" name="discounted" value="${bundle.discounted}" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Save Percentage</label>
                            <input type="number" name="save_percent" value="${bundle.save_percent || 0}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Bundle Items *</label>
                            <div id="bundle-items-container"></div>
                            <button type="button" onclick="addBundleItemRow('bundle-items-container')" class="btn-sm" style="margin-top:10px;"><i class="fas fa-plus"></i> Add Item</button>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:20px;">
                            <button type="submit" class="btn-sm" style="background: var(--success);">‚úÖ Update Bundle</button>
                            <button type="button" onclick="renderBundlesSection()" class="btn-sm" style="background:#6c757d;">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            contentArea.innerHTML = formHtml;
            
            // Populate rows with existing items
            const container = document.getElementById('bundle-items-container');
            if (Array.isArray(bundle.items)) {
                bundle.items.forEach(item => addBundleItemRow('bundle-items-container', item));
            } else {
                addBundleItemRow('bundle-items-container'); // fallback empty row
            }
        }

        async function saveBundle(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            // Gather items from rows
            const container = document.getElementById('bundle-items-container');
            const rows = container.querySelectorAll('.bundle-item-row');
            const items = [];
            for (let row of rows) {
                const inputs = row.querySelectorAll('input');
                const name = inputs[0].value.trim();
                const price = parseFloat(inputs[1].value);
                const url = inputs[2].value.trim() || null;
                if (name && !isNaN(price)) {
                    items.push({ name, price, url });
                }
            }
            
            if (items.length === 0) {
                showMessage('Please add at least one item.', true);
                return;
            }
            
            const bundle = {
                name: formData.get('name'),
                total: parseInt(formData.get('total')),
                discounted: parseInt(formData.get('discounted')),
                save_percent: parseInt(formData.get('save_percent')) || null,
                items: items
            };
            
            const { error } = await supabaseAdmin.from('bundles').insert(bundle);
            if (error) showMessage('Error: ' + error.message, true);
            else { showMessage('Bundle added!'); renderBundlesSection(); }
        }

        async function updateBundle(e, id) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            // Gather items from rows
            const container = document.getElementById('bundle-items-container');
            const rows = container.querySelectorAll('.bundle-item-row');
            const items = [];
            for (let row of rows) {
                const inputs = row.querySelectorAll('input');
                const name = inputs[0].value.trim();
                const price = parseFloat(inputs[1].value);
                const url = inputs[2].value.trim() || null;
                if (name && !isNaN(price)) {
                    items.push({ name, price, url });
                }
            }
            
            if (items.length === 0) {
                showMessage('Please add at least one item.', true);
                return;
            }
            
            const bundle = {
                name: formData.get('name'),
                total: parseInt(formData.get('total')),
                discounted: parseInt(formData.get('discounted')),
                save_percent: parseInt(formData.get('save_percent')) || null,
                items: items
            };
            
            const { error } = await supabaseAdmin.from('bundles').update(bundle).eq('id', id);
            if (error) showMessage('Error: ' + error.message, true);
            else { showMessage('Bundle updated!'); renderBundlesSection(); }
        }

        async function deleteBundle(id) {
            if (!confirm('Delete this bundle?')) return;
            const { error } = await supabaseAdmin.from('bundles').delete().eq('id', id);
            if (error) showMessage('Error: ' + error.message, true);
            else { showMessage('Bundle deleted.'); renderBundlesSection(); }
        }

        // ---------- REVIEWS MANAGEMENT ----------
        async function renderReviewsSection() {
            contentArea.innerHTML = `<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i> Loading reviews...</div>`;
            const { data: reviews } = await supabaseAdmin.from('reviews').select('*, products(name)').order('created_at', { ascending: false });
            let html = `
                <h2 class="section-title"><i class="fas fa-star"></i> Customer Reviews</h2>
                <div class="table-responsive">
                    <table>
                        <thead><tr><th>Product</th><th>Reviewer</th><th>Rating</th><th>Comment</th><th>Date</th><th>Action</th></tr></thead>
                        <tbody>
                            ${reviews?.map(r => `
                                <tr>
                                    <td>${r.products?.name || 'Deleted product'}</td>
                                    <td>${r.reviewer}</td>
                                    <td>${'‚≠ê'.repeat(r.rating)} (${r.rating})</td>
                                    <td>${r.comment || ''}</td>
                                    <td>${new Date(r.date).toLocaleDateString()}</td>
                                    <td><button onclick="deleteReview(${r.id})" class="btn-sm btn-danger"><i class="fas fa-trash"></i></button></td>
                                </tr>
                            `).join('') || '<tr><td colspan="6">No reviews yet</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
            contentArea.innerHTML = html;
        }

        async function deleteReview(reviewId) {
            if (!confirm('Delete this review?')) return;
            const { error } = await supabaseAdmin.from('reviews').delete().eq('id', reviewId);
            if (error) showMessage('Error: ' + error.message, true);
            else { showMessage('Review deleted.'); renderReviewsSection(); }
        }

        // ---------- SETTINGS MANAGEMENT (for general settings) ----------
        async function renderSettingsSection() {
            contentArea.innerHTML = `<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i> Loading settings...</div>`;
            const { data: settings } = await supabaseAdmin.from('settings').select('*');

            const getVal = (key, defaultVal) => {
                const found = settings?.find(s => s.key === key);
                return found ? found.value : defaultVal;
            };

            const deliveryFeeBelow = getVal('delivery_fee_below', 5000);
            const freeThreshold = getVal('free_delivery_threshold', 200000);
            const flashEnd = getVal('flash_sale_end_time', { end_time: new Date(Date.now() + 86400000).toISOString() });
            const flashEndStr = flashEnd.end_time ? new Date(flashEnd.end_time).toISOString().slice(0,16) : '';

            const html = `
                <h2 class="section-title"><i class="fas fa-cog"></i> Store Settings</h2>
                <div class="form-container" style="max-width:600px;">
                    <h3 style="color:var(--brand-blue); margin-bottom:15px;">üöö Delivery Rule</h3>
                    <div class="form-group">
                        <label>Delivery Fee (for orders below threshold) ‚Äì UGX</label>
                        <input type="number" id="setting_delivery_fee_below" class="form-control" value="${deliveryFeeBelow}">
                    </div>
                    <div class="form-group">
                        <label>Free Delivery Threshold ‚Äì UGX</label>
                        <input type="number" id="setting_free_threshold" class="form-control" value="${freeThreshold}">
                    </div>
                    <hr style="margin:25px 0;">
                    <h3 style="color:var(--brand-blue); margin-bottom:15px;">‚è∞ Flash Sale</h3>
                    <div class="form-group">
                        <label>Flash Sale End Date/Time</label>
                        <input type="datetime-local" id="setting_flash_end" class="form-control" value="${flashEndStr}">
                    </div>
                    <button onclick="saveSettings()" class="btn-sm" style="background: var(--success);">üíæ Save All Settings</button>
                    <button onclick="loadSection('dashboard')" class="btn-sm" style="background:#6c757d;">Cancel</button>
                </div>
            `;
            contentArea.innerHTML = html;
        }

        async function saveSettings() {
            const deliveryFeeBelow = parseInt(document.getElementById('setting_delivery_fee_below').value) || 5000;
            const freeThreshold = parseInt(document.getElementById('setting_free_threshold').value) || 200000;
            const flashEnd = document.getElementById('setting_flash_end').value;

            try {
                await supabaseAdmin.from('settings').upsert({ key: 'delivery_fee_below', value: deliveryFeeBelow }, { onConflict: 'key' });
                await supabaseAdmin.from('settings').upsert({ key: 'free_delivery_threshold', value: freeThreshold }, { onConflict: 'key' });
                if (flashEnd) {
                    await supabaseAdmin.from('settings').upsert({ key: 'flash_sale_end_time', value: { end_time: new Date(flashEnd).toISOString() } }, { onConflict: 'key' });
                }
                showMessage('Settings saved successfully!');
                renderSettingsSection();
            } catch (e) {
                showMessage('Error saving settings: ' + e.message, true);
            }
        }

        // ========== NEW: CONTACT SETTINGS (no JSON textareas) ==========
        async function renderContactSettings() {
            contentArea.innerHTML = `<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i> Loading contact settings...</div>`;
            const { data: settings } = await supabaseAdmin.from('settings').select('key, value');

            const getVal = (key, defaultVal) => {
                const found = settings?.find(s => s.key === key);
                return found ? found.value : defaultVal;
            };

            const address = getVal('contact_address', 'GBK Plaza, along Ntare Road, opposite Stanbic Bank, Shop No. G05, Mbarara, Uganda');
            const phoneMtn = getVal('contact_phone_mtn', '+256 786 544 501');
            const phoneAirtel = getVal('contact_phone_airtel', '+256 755 712 526');
            const email = getVal('contact_email', 'israelgadgetsmbarara@mail.com');
            const socialTwitter = getVal('social_twitter', 'https://x.com/israelgadgets');
            const socialTiktok = getVal('social_tiktok', 'https://tiktok.com/@israelgadgetsmbra');
            const socialInstagram = getVal('social_instagram', 'https://instagram.com/israelgadgets.mbarara');
            const socialFacebook = getVal('social_facebook', 'https://facebook.com');
            const businessHours = getVal('business_hours', [
                { days: 'Monday - Saturday', hours: '8:00 AM ‚Äì 7:00 PM' },
                { days: 'Sunday', hours: '10:00 AM ‚Äì 5:00 PM' },
                { days: 'Public Holidays', hours: '10:00 AM ‚Äì 4:00 PM' }
            ]);
            const faqItems = getVal('faq_items', [
                { question: 'Do you ship outside Mbarara?', answer: 'Yes, we ship anywhere in Uganda. Delivery fees depend on your location.' },
                { question: 'What is your return policy?', answer: 'We accept returns within 7 days if the item is unused and in original packaging.' },
                { question: 'Do you offer warranties on gadgets?', answer: 'Yes, most items come with a 6-month warranty.' },
                { question: 'How quickly do you respond to messages?', answer: 'We usually reply within 2 hours during business hours.' }
            ]);

            // Build dynamic rows HTML with placeholders for business hours and FAQ
            let html = `
                <h2 class="section-title"><i class="fas fa-address-book"></i> Contact Settings</h2>
                <div class="form-container" style="max-width:800px;">
                    <form id="contact-settings-form" onsubmit="saveContactSettings(event)">
                        <h3>üìç Address</h3>
                        <textarea name="contact_address" class="form-control" rows="2">${address}</textarea>

                        <h3 style="margin-top:25px;">üìû Phones</h3>
                        <label>MTN</label>
                        <input type="text" name="contact_phone_mtn" value="${phoneMtn}" class="form-control">
                        <label>Airtel</label>
                        <input type="text" name="contact_phone_airtel" value="${phoneAirtel}" class="form-control">

                        <h3 style="margin-top:25px;">üìß Email</h3>
                        <input type="email" name="contact_email" value="${email}" class="form-control">

                        <h3 style="margin-top:25px;">üåê Social Links</h3>
                        <label>Twitter/X</label>
                        <input type="url" name="social_twitter" value="${socialTwitter}" class="form-control">
                        <label>TikTok</label>
                        <input type="url" name="social_tiktok" value="${socialTiktok}" class="form-control">
                        <label>Instagram</label>
                        <input type="url" name="social_instagram" value="${socialInstagram}" class="form-control">
                        <label>Facebook</label>
                        <input type="url" name="social_facebook" value="${socialFacebook}" class="form-control">

                        <h3 style="margin-top:25px;">üïí Business Hours</h3>
                        <div id="business-hours-container"></div>
                        <button type="button" class="btn-add-row" onclick="addBusinessHourRow()">+ Add Business Hours Row</button>

                        <h3 style="margin-top:25px;">‚ùì FAQ Items</h3>
                        <div id="faq-container"></div>
                        <button type="button" class="btn-add-row" onclick="addFaqRow()">+ Add FAQ Item</button>

                        <div style="margin-top:30px;">
                            <button type="submit" class="btn-sm" style="background:var(--success);">üíæ Save Contact Settings</button>
                            <button type="button" onclick="loadSection('dashboard')" class="btn-sm" style="background:#6c757d;">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            contentArea.innerHTML = html;

            // Populate business hours rows
            const bhContainer = document.getElementById('business-hours-container');
            businessHours.forEach(item => addBusinessHourRow(item.days, item.hours));

            // Populate FAQ rows
            const faqContainer = document.getElementById('faq-container');
            faqItems.forEach(item => addFaqRow(item.question, item.answer));
        }

        // Helper to add a business hour row
        function addBusinessHourRow(days = '', hours = '') {
            const container = document.getElementById('business-hours-container');
            const row = document.createElement('div');
            row.className = 'dynamic-row';
            row.innerHTML = `
                <div class="field"><input type="text" class="form-control bh-days" placeholder="e.g., Monday - Friday" value="${days.replace(/"/g, '&quot;')}"></div>
                <div class="field"><input type="text" class="form-control bh-hours" placeholder="e.g., 9:00 AM - 6:00 PM" value="${hours.replace(/"/g, '&quot;')}"></div>
                <button type="button" class="btn-remove-row" onclick="this.parentElement.remove()">‚úñ</button>
            `;
            container.appendChild(row);
        }

        // Helper to add an FAQ row
        function addFaqRow(question = '', answer = '') {
            const container = document.getElementById('faq-container');
            const row = document.createElement('div');
            row.className = 'dynamic-row';
            row.innerHTML = `
                <div class="field"><input type="text" class="form-control faq-question" placeholder="Question" value="${question.replace(/"/g, '&quot;')}"></div>
                <div class="field"><textarea class="form-control faq-answer" placeholder="Answer" rows="2">${answer.replace(/"/g, '&quot;')}</textarea></div>
                <button type="button" class="btn-remove-row" onclick="this.parentElement.remove()">‚úñ</button>
            `;
            container.appendChild(row);
        }

        async function saveContactSettings(e) {
            e.preventDefault();

            // Collect simple fields
            const formData = new FormData(e.target);
            const settings = [
                { key: 'contact_address', value: formData.get('contact_address') },
                { key: 'contact_phone_mtn', value: formData.get('contact_phone_mtn') },
                { key: 'contact_phone_airtel', value: formData.get('contact_phone_airtel') },
                { key: 'contact_email', value: formData.get('contact_email') },
                { key: 'social_twitter', value: formData.get('social_twitter') },
                { key: 'social_tiktok', value: formData.get('social_tiktok') },
                { key: 'social_instagram', value: formData.get('social_instagram') },
                { key: 'social_facebook', value: formData.get('social_facebook') }
            ];

            // Collect business hours rows
            const bhRows = document.querySelectorAll('#business-hours-container .dynamic-row');
            const businessHours = [];
            bhRows.forEach(row => {
                const days = row.querySelector('.bh-days')?.value.trim();
                const hours = row.querySelector('.bh-hours')?.value.trim();
                if (days || hours) {
                    businessHours.push({ days, hours });
                }
            });
            settings.push({ key: 'business_hours', value: businessHours });

            // Collect FAQ rows
            const faqRows = document.querySelectorAll('#faq-container .dynamic-row');
            const faqItems = [];
            faqRows.forEach(row => {
                const question = row.querySelector('.faq-question')?.value.trim();
                const answer = row.querySelector('.faq-answer')?.value.trim();
                if (question || answer) {
                    faqItems.push({ question, answer });
                }
            });
            settings.push({ key: 'faq_items', value: faqItems });

            try {
                for (let s of settings) {
                    await supabaseAdmin.from('settings').upsert(s, { onConflict: 'key' });
                }
                showMessage('Contact settings saved!');
                renderContactSettings();
            } catch (err) {
                showMessage('Error: ' + err.message, true);
            }
        }

        // ========== NEW: LOCATION SETTINGS (no JSON textareas) ==========
        async function renderLocationSettings() {
            contentArea.innerHTML = `<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i> Loading location settings...</div>`;
            const { data: settings } = await supabaseAdmin.from('settings').select('key, value');

            const getVal = (key, defaultVal) => {
                const found = settings?.find(s => s.key === key);
                return found ? found.value : defaultVal;
            };

            const address = getVal('location_address', 'GBK Plaza, along Ntare Road, opposite Stanbic Bank, Shop No. G05, Mbarara, Uganda');
            const coords = getVal('location_coordinates', '-0.607411, 30.660626');
            const deliveryAreas = getVal('delivery_areas', [
                { area: 'Mbarara', fee: 0, free_threshold: 200000 },
                { area: 'Ishaka', fee: 0, free_threshold: 200000 },
                { area: 'Bushenyi', fee: 0, free_threshold: 200000 }
            ]);
            const deliveryFeeBelow = getVal('delivery_fee_below', 5000);
            const freeThreshold = getVal('free_delivery_threshold', 200000);

            let html = `
                <h2 class="section-title"><i class="fas fa-map-marked-alt"></i> Location Settings</h2>
                <div class="form-container" style="max-width:800px;">
                    <form id="location-settings-form" onsubmit="saveLocationSettings(event)">
                        <h3>üìç Shop Address</h3>
                        <textarea name="location_address" rows="3" class="form-control">${address}</textarea>

                        <h3 style="margin-top:25px;">üåê Coordinates (lat, lng)</h3>
                        <input type="text" name="location_coordinates" value="${coords}" class="form-control">

                        <h3 style="margin-top:25px;">üöö Delivery Areas</h3>
                        <div id="delivery-areas-container"></div>
                        <button type="button" class="btn-add-row" onclick="addDeliveryAreaRow()">+ Add Delivery Area</button>

                        <h3 style="margin-top:25px;">üí∞ Delivery Fee (below threshold)</h3>
                        <input type="number" name="delivery_fee_below" value="${deliveryFeeBelow}" class="form-control">

                        <h3>üéÅ Free Delivery Threshold (UGX)</h3>
                        <input type="number" name="free_delivery_threshold" value="${freeThreshold}" class="form-control">

                        <div style="margin-top:30px;">
                            <button type="submit" class="btn-sm" style="background:var(--success);">üíæ Save Location Settings</button>
                            <button type="button" onclick="loadSection('dashboard')" class="btn-sm" style="background:#6c757d;">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            contentArea.innerHTML = html;

            // Populate delivery areas rows
            const daContainer = document.getElementById('delivery-areas-container');
            deliveryAreas.forEach(item => addDeliveryAreaRow(item.area, item.fee, item.free_threshold));
        }

        // Helper to add a delivery area row
        function addDeliveryAreaRow(area = '', fee = 0, threshold = 200000) {
            const container = document.getElementById('delivery-areas-container');
            const row = document.createElement('div');
            row.className = 'dynamic-row';
            row.innerHTML = `
                <div class="field"><input type="text" class="form-control da-area" placeholder="Area name" value="${area.replace(/"/g, '&quot;')}"></div>
                <div class="field"><input type="number" class="form-control da-fee" placeholder="Delivery fee" value="${fee}"></div>
                <div class="field"><input type="number" class="form-control da-threshold" placeholder="Free threshold" value="${threshold}"></div>
                <button type="button" class="btn-remove-row" onclick="this.parentElement.remove()">‚úñ</button>
            `;
            container.appendChild(row);
        }

        async function saveLocationSettings(e) {
            e.preventDefault();
            const formData = new FormData(e.target);

            // Collect simple fields
            const settings = [
                { key: 'location_address', value: formData.get('location_address') },
                { key: 'location_coordinates', value: formData.get('location_coordinates') },
                { key: 'delivery_fee_below', value: parseInt(formData.get('delivery_fee_below')) },
                { key: 'free_delivery_threshold', value: parseInt(formData.get('free_delivery_threshold')) }
            ];

            // Collect delivery areas rows
            const daRows = document.querySelectorAll('#delivery-areas-container .dynamic-row');
            const deliveryAreas = [];
            daRows.forEach(row => {
                const area = row.querySelector('.da-area')?.value.trim();
                const fee = parseFloat(row.querySelector('.da-fee')?.value) || 0;
                const threshold = parseFloat(row.querySelector('.da-threshold')?.value) || 0;
                if (area) {
                    deliveryAreas.push({ area, fee, free_threshold: threshold });
                }
            });
            settings.push({ key: 'delivery_areas', value: deliveryAreas });

            try {
                for (let s of settings) {
                    await supabaseAdmin.from('settings').upsert(s, { onConflict: 'key' });
                }
                showMessage('Location settings saved!');
                renderLocationSettings();
            } catch (err) {
                showMessage('Error: ' + err.message, true);
            }
        }

        // ---------- USERS MANAGEMENT ----------
        async function renderUsersSection() {
            contentArea.innerHTML = `<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i> Loading users...</div>`;
            const { data: users } = await supabaseAdmin
                .from('profiles')
                .select('*')
                .not('role', 'in', '("super_admin","content_manager","support_staff")')
                .order('created_at', { ascending: false });
            let html = `
                <h2 class="section-title"><i class="fas fa-users"></i> Customers</h2>
                <div class="table-responsive">
                    <table>
                        <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Role</th><th>Joined</th><th>Action</th></tr></thead>
                        <tbody>
                            ${users?.map(u => `
                                <tr>
                                    <td>${u.full_name || '‚Äî'}</td>
                                    <td>${u.email}</td>
                                    <td>${u.phone || '‚Äî'}</td>
                                    <td>${u.role}</td>
                                    <td>${new Date(u.created_at).toLocaleDateString()}</td>
                                    <td>
                                        <button onclick="makeAdmin('${u.id}')" class="btn-sm" style="background: var(--brand-blue);">Make Super Admin</button>
                                    </td>
                                </tr>
                            `).join('') || '<tr><td colspan="6">No non-admin users</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
            contentArea.innerHTML = html;
        }

        async function makeAdmin(userId) {
            if (!confirm('Are you sure you want to grant super_admin privileges to this user?')) return;
            const { error } = await supabaseAdmin.from('profiles').update({ role: 'super_admin' }).eq('id', userId);
            if (error) showMessage('Error: ' + error.message, true);
            else { showMessage('User is now a super_admin.'); renderUsersSection(); }
        }

        // ========== GLOBAL FUNCTION REFERENCES ==========
        window.loadSection = loadSection;
        window.updateSalesGraph = updateSalesGraph;   // expose for dropdown onchange
        // Categories
        window.showAddCategoryForm = showAddCategoryForm;
        window.editCategory = editCategory;
        window.deleteCategory = deleteCategory;
        window.saveCategory = saveCategory;
        window.updateCategory = updateCategory;
        window.renderCategoriesSection = renderCategoriesSection;
        // Products
        window.showAddProductForm = showAddProductForm;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.saveProduct = saveProduct;
        window.updateProduct = updateProduct;
        window.renderProductsSection = renderProductsSection;
        // Orders
        window.updateOrderStatus = updateOrderStatus;
        window.renderOrdersSection = renderOrdersSection;
        // Order Items
        window.renderOrderItemsSection = renderOrderItemsSection;
        // Promotions (both promo codes and rotator)
        window.renderPromotionsSection = renderPromotionsSection;
        window.showAddPromoForm = showAddPromoForm;
        window.editPromo = editPromo;
        window.savePromo = savePromo;
        window.updatePromo = updatePromo;
        window.deletePromo = deletePromo;
        window.showAddPromoRotatorForm = showAddPromoRotatorForm;
        window.editPromoRotator = editPromoRotator;
        window.savePromoRotator = savePromoRotator;
        window.updatePromoRotator = updatePromoRotator;
        window.deletePromoRotator = deletePromoRotator;
        // Bundles (new functions)
        window.renderBundlesSection = renderBundlesSection;
        window.showAddBundleForm = showAddBundleForm;
        window.editBundle = editBundle;
        window.saveBundle = saveBundle;
        window.updateBundle = updateBundle;
        window.deleteBundle = deleteBundle;
        window.addBundleItemRow = addBundleItemRow;
        // Reviews
        window.renderReviewsSection = renderReviewsSection;
        window.deleteReview = deleteReview;
        // Settings
        window.saveSettings = saveSettings;
        window.renderSettingsSection = renderSettingsSection;
        // Contact & Location (new dynamic functions)
        window.renderContactSettings = renderContactSettings;
        window.saveContactSettings = saveContactSettings;
        window.addBusinessHourRow = addBusinessHourRow;
        window.addFaqRow = addFaqRow;
        window.renderLocationSettings = renderLocationSettings;
        window.saveLocationSettings = saveLocationSettings;
        window.addDeliveryAreaRow = addDeliveryAreaRow;
        // Users
        window.makeAdmin = makeAdmin;
        window.renderUsersSection = renderUsersSection;
        // Logout & auth
        window.handleLogout = handleLogout;
        window.toggleAuthMode = toggleAuthMode;
    </script>
</body>
</html>